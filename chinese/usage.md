# 使用

- [使用 `Shell`](#使用-Shell)

- [使用 `Shell GUI`](#使用-Shell-GUI)

- [工具交互](#工具交互)

- [配置文件](#配置文件)

- [附加参数](#附加参数)

- [转发文件对象](#转发文件对象)

- [脚本概述](#脚本概述)

- [第三方集成](#第三方集成)

- [使用 `Helper`](#使用-Helper)

## 使用 `Shell`

`Shell` 为用户提供了命令行界面。

用户需要在终端中启动 `Shell` ，命令行参数的格式如下：

`<core> <script> <argument>...`

* `<core>`
	
	第一参数为核心文件路径。

* `<script>`
	
	第二参数是传给核心处理逻辑的脚本。该参数是一段表示 JS 脚本的字符串，或以 `?` 为首字符作为标识的脚本文件路径。

* `<argument>...`
	
	剩余参数作为传给核心处理逻辑的参数。

若执行过程无错误发生，则 main 函数返回值为 0 ，否则为 1 。

为了方便使用，可以创建一个启动脚本，用于启动 `Shell` 并传递一些必需参数。分发中提供了适用于各平台的启动脚本，可以按照以下步骤安装：

1. 查看 [分发页面](https://github.com/twinkles-twinstar/TwinStar.ToolKit.Document/releases/tag/Miscellaneous) ，下载适用于你设备的分发。

2. 将下载所得文件移动到主目录内，并重命名为 `launch` ，但保留原有扩展名。

3. 运行以测试启动脚本，如果操作无误，你可以在终端中看到 `Shell` 被成功启动。
	
	> 可以向启动脚本传递附加参数，所有附加参数将自动转发至 `Shell` 。

## 使用 `Shell GUI`

`Shell GUI` 为用户提供了图形界面。

用户可以像使用普通应用一样使用 `Shell GUI` 。

首次打开应用时，需要在应用设置中指定运行时使用的核心、脚本、参数，典型的配置如下：

1. 将 `核心` 项的值设为 `<home>/core` 。

2. 将 `脚本` 项的值设为 `?<home>/script/main.js` 。

3. 将 `参数` 项的值设为 `<home>` 。

> 上述设置中的 `<home>` 需要替换为主目录的路径。
> 
> @ `Android` \
> 在 `Android` 中，`FUSE` 机制会降低应用对外部存储空间内文件的读写性能，这一影响在对小文件的读写时尤为明显；因此，推荐将主目录放置于应用的内部存储目录 `/data/user/<id>/<package>` 或外部存储目录 `/storage/emulated/<id>/Android/data/<package>` 中，这将有效提高主目录下的文件读写性能，特别是脚本的加载速度。

同样支持在终端中启动 `Shell GUI` ，命令行参数的格式如下：

`[<ignore> <additional-argument>...]`

* `<ignore>`
	
	第一参数作为命令启动模式的标识，其值被忽略。

* `<additional-argument>...`
	
	剩余参数作为传给核心处理逻辑的附加参数。

若不传入命令行参数，则直接启动应用。

若传入命令行参数，则应用将在命令执行完毕且成功后自动退出（可以在应用设置内禁用此行为）。

> 不支持通过命令行指定核心路径、脚本，必须先在应用设置内正确设定它们的值。

对于 Android 系统，应用还支持以 ⌈ 文件分享功能 ⌋ 启动应用，它等效于将文件路径作为附加参数启动应用。你可以在第三方应用中选择文件对象，再通过 ⌈ 文件分享功能 ⌋ 将文件对象转发给应用。

> 第三方应用传递的 URI 必须以 file 或 media 协议明文指向外存空间中的文件对象，否则应用无法解析得到真正的文件对象。

## 工具交互

工具运行时会向用户输出消息，或请求用户输入一些参数；`Shell` 与 `Shell GUI` 提供了基本一致的交互逻辑。

### 输出

不同类型的通知具有不同颜色，并以相应颜色的实心圆图标作为标志图标：

* `⚪` 常规（暗色主题）

* `⚫` 常规（亮色主题）

* `🔵` 信息

* `🟡` 警告

* `🔴` 错误

* `🟢` 成功

* `🟣` 输入

### 输入

六种通知类型中，`🟣` 表示工具向用户请求输入参数，工具将停止其他工作并等待用户输入，直到用户输入完毕后键入回车以结束该行输入。

请求输入时，还会显示一个前导字符作为参数类型的提示，输入值类型及格式如下：

* `U` 暂停
	
	暂停程序等待用户响应。

* `C` 确认值
	
	单个字符 ⌈ y ⌋ 或 ⌈ n ⌋ ，表示 ⌈ 是 ⌋ 与 ⌈ 否 ⌋ 。

* `N` 数字
	
	一个十进制数字。

* `I` 整数
	
	一个十进制整数，不可包含小数点。

* `Z` 尺寸
	
	一个无符号十进制整数，后跟随一个二进制单位（ b = 2^0 , k = 2^10 , m = 2^20 , g = 2^30 ），一般用于表示存储容量。
	
	> 例如 ⌈ 4k ⌋ 表示 4096 字节的存储容量。

* `O` 选项
	
	通过整数序号选择一个可选项。

* `S` 字符串
	
	一行文本。

* `P` 输入路径
	
	指向磁盘上一个已存在的文件或目录的路径。
	
	> 也可输入 `:p` 唤起文件选择窗口（仅限 `Windwos` 、`Linux` 、`Macintosh` ）。
	> 
	> 如果输入路径由一对双引号包围，将自动去除引号；如果在输入了一段相对路径，则该路径是相对于工具的工作目录 `+ <home>/workspace` 计算的。

* `P` 输出路径
	
	指向磁盘上一个不存在的路径。工具一般会自动生成默认输出路径，但在默认输出路径已被占用时会请求输入新的输出路径。
	
	> 也可输入 `:o` 覆写已有文件；
	> 或是输入 `:d` 删除已有文件；\
	> 或是输入 `:t` 移动已有文件至工具的回收目录 `+ <home>/trash` 。
	> 
	> 如果输入路径由一对双引号包围，将自动去除引号；如果在输入了一段相对路径，则该路径是相对于工具的工作目录 `+ <home>/workspace` 计算的。

## 配置文件

在脚本目录 `+ <home>/script` 中，有些脚本文件拥有配套的配置文件，其名称与对应的脚本文件相同，但以 `.json` 为扩展名。配置属性会影响工具的某些行为，如 JSON 的输出格式。

> 例如，脚本目录下的一个脚本 `- Entry/Entry.js` 拥有配置文件，配置文件为 `- Entry/Entry.json` 。

用户可以自行修改配置文件，各配置文件的规范可以参考 [功能](./method.md) 章节。

## 附加参数

用户可以在启动工具时传入附加参数，若未提供附加参数，则会在运行时要求用户输入。附加参数如下格式：

```
[
    <input>
    [ -disable_filter ]
    [ -method <method-id> ]
    [ -argument <argument-json> ]
]...
```

* `<input>`
	
	指定了命令的输入数据，一般是文件或目录的路径，作为功能的输入参数。

* `[ -disable_filter ]`
	
	用于禁用 ⌈ 候选功能过滤 ⌋ 。
	
	默认情况下，如果未指定 `-method` ，工具将根据输入对象的类型（主要通过扩展名）筛选出可用功能供用户选择；
	
	若禁用 ⌈ 候选功能过滤 ⌋ ，则将列出所有功能供用户选择。

* `[ -method <method-id> ]`
	
	指定需执行的功能，后跟该功能的 ID ，若未指定功能，将在运行时等待用户选择功能。

* `[ -argument <argument-json> ]`
	
	指定需要传给功能的参数，后跟一个 JSON 字符串，且必须可解析为一个 Object 。

各功能的 ID 与其参数定义参见 [功能](./method.md) 章节。

> 例 - 使用工具解码桌面上的 `test.pam` 文件：
> 
> `> .\launch.cmd "C:\Users\TwinStar\Desktop\test.pam" "-method" "popcap.animation.decode"`
> 
> 该命令以 `test.pam` 文件的路径作为输入参数，并指定需执行的功能为 `PopCap Animation 解码` 。执行完毕后，可在桌面看到一个名为 `test.pam.json` 的新文件，即为解码后的 PAM 数据。

## 转发文件对象

工具被设计为主要处理外存空间中的文件对象，术语 ⌈ **转发** ⌋ 是指以文件对象的路径作为附加参数以启动工具。可以通过启动脚本、Android 文件分享功能、Windows Explorer 扩展等方式进行转发。

将需要处理的文件对象转发给工具，工具启动后，会根据该文件对象的类型列出可用功能，用户输入需要执行的功能序号即可。

工具预置了丰富的功能，如 RTON 编解码、RSB 解包，详见 [功能](./method.md) 章节。

## 脚本概述

> **对于大多用户，预置功能已经足够使用，但如果你希望通过自定义脚本来提高你的工作效率，可以继续了解。**\
> **以下内容面向有编程基础的用户。**

本工具以 `JavaScript` 作为脚本语言。JS 引擎为第三方开源项目 `quickjs` 。

简单来说，外壳 `Shell` 所做的工作只有两件：

1. 加载 ⌈ 核心库 ⌋ ，其中了定义了面向 JS 的 `Core interface` 。
	
	工具的各类功能都是由脚本以直接或间接调用 `Core interface` 的方式提供给用户的，它提供了文件读写、数据操作等基本功能与 BNK 、PAM 编解码等高级功能。
	
	> `Core interface` 的接口具有严格的类型限制，因此，在开发层面，应使用 `TypeScript` 作为开发语言，并编译为 JS 供工具使用。其 `.d.ts` 声明包含在脚本模块项目中。

2. 执行 ⌈ 主脚本 ⌋ ，其路径通过启动脚本被设定为 `- <home>/script/main.js` 。
	
	工具要求主脚本计算出的值为一个函数，即脚本层的 ⌈ 主函数 ⌋ ，其拥有如下类型：
	
	```ts
	type JS_MainFunction = (
		argument: Array<string>,
	) => string;
	```
	
	工具传递启动参数以调用该函数，直到该函数执行完毕，工具结束运行。

用户可以自行重写主脚本的运行逻辑，但更推荐在已有的 [Script 模块](https://github.com/twinkles-twinstar/TwinStar.ToolKit/tree/master/Script) 基础上扩展开发，它已为用户提供了丰富的功能与良好的交互机制。

## 第三方集成

> **以下内容面向有编程基础的用户。**

本工具采用前后端分离架构，分为三个层级：

* 核心：后端，负责数据处理，不会进行任何用户交互；核心被分发为面向各平台的本机动态库文件。

* 外壳：前端，负责用户交互，不会进行任何数据处理；外壳会加载核心动态库，并以用户提供的脚本作为参数调用核心动态库的接口函数。

* 脚本：前后端的桥梁，通过调用核心与外壳提供的接口函数进行数据处理与用户交互。

工具的前后端完全解耦，用户可以通过 `C` 、`C++` 、`C#` 、`Java` 、`Kotlin` 、`Python` 在内的各类编程语言所提供的 `Foreign Function Interface` 机制将工具后端（核心）集成至自己的项目中，主要步骤如下：

1. 在自定义项目中加载本工具的后端（即核心模块分发的动态库文件），获取核心的接口函数。

2. 调用核心的接口函数，接口函数中的 `callback` 参数是自定义项目所需要提供的外壳回调实现。

具体参照本工具内的几个外壳实现：

* `Shell` with [`C++`](https://github.com/twinkles-twinstar/TwinStar.ToolKit/tree/master/Shell/shell/core)

* `Shell GUI` with [`Dart`](https://github.com/twinkles-twinstar/TwinStar.ToolKit/tree/master/ShellGUI/lib/core)

* `Helper` with [`C#`](https://github.com/twinkles-twinstar/TwinStar.ToolKit/tree/master/Helper/Core)

## 使用 `Helper`

`Helper` 为用户提供了额外的高级功能。

目前仅提供 PopCap Animation 动画查看功能。

1. 启动应用，在主页面上点击 `Animation Viewer` 。

2. 点击新页面右侧上方的 `Animation File` 文本框的右侧按钮，在弹出的窗口中选择 `*.pam.json` 动画文件。
	
	> `*.pam.json` 由工具解码 `*.pam` 文件而得。

3. 如果动画所需的分解图位于动画文件同级目录内，则可以正常渲染动画，否则需要点击 `Image Directory` 文本框的右侧按钮，选择分解图所在目录。

4. 通过其他 UI 控件可以选择想要播放的子动画、调整播放区间与帧率、设置元件过滤项、等。
